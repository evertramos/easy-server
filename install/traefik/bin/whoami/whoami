#!/usr/bin/env bash
#
# whoami - Test Traefik routing with traefik/whoami container
#
# Usage:
#   ./bin/whoami up      Start whoami container
#   ./bin/whoami down    Stop and remove whoami container
#   ./bin/whoami test    Test the endpoint with curl
#   ./bin/whoami logs    Show whoami logs
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TRAEFIK_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$SCRIPT_DIR/whoami.env"
COMPOSE_FILE="$SCRIPT_DIR/whoami-compose.yml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[INFO]${NC} $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

check_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        error "Environment file not found: $ENV_FILE"
        echo ""
        echo "Create it with:"
        echo "  cp $SCRIPT_DIR/whoami.env.example $ENV_FILE"
        echo "  vi $ENV_FILE"
        exit 1
    fi
    # shellcheck source=/dev/null
    source "$ENV_FILE"
}

cmd_up() {
    check_env
    info "Starting whoami container..."
    docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" up -d
    info "Whoami is running at: https://${WHOAMI_DOMAIN}"
    echo ""
    info "Test with: $0 test"
}

cmd_down() {
    info "Stopping whoami container..."
    docker compose -f "$COMPOSE_FILE" down 2>/dev/null || true
    info "Whoami stopped and removed"
}

cmd_test() {
    check_env
    info "Testing whoami at https://${WHOAMI_DOMAIN}..."
    echo ""

    if command -v curl &>/dev/null; then
        curl -sS --connect-timeout 5 "https://${WHOAMI_DOMAIN}" || {
            error "Failed to connect. Check if:"
            echo "  1. Traefik is running"
            echo "  2. Whoami is running ($0 up)"
            echo "  3. DNS is configured for ${WHOAMI_DOMAIN}"
            echo "  4. Certificate is valid"
            exit 1
        }
    else
        error "curl not found"
        exit 1
    fi
}

cmd_logs() {
    docker logs whoami-test -f 2>/dev/null || {
        error "Whoami container not running. Start with: $0 up"
        exit 1
    }
}

show_help() {
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  up      Start whoami container"
    echo "  down    Stop and remove whoami container"
    echo "  test    Test the endpoint with curl"
    echo "  logs    Show whoami logs (follow)"
    echo ""
    echo "Environment:"
    echo "  Configure $ENV_FILE before running"
}

case "${1:-}" in
    up)    cmd_up ;;
    down)  cmd_down ;;
    test)  cmd_test ;;
    logs)  cmd_logs ;;
    -h|--help|help) show_help ;;
    *)
        error "Unknown command: ${1:-}"
        show_help
        exit 1
        ;;
esac
