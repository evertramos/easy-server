#!/usr/bin/env bash
#
# update-cloudflare-ips - Update Cloudflare IP ranges in Traefik config
#
# Usage:
#   ./bin/update-cloudflare-ips [OPTIONS]
#
# Options:
#   --dry-run    Show changes without applying
#   --force      Apply changes without confirmation
#   --no-reload  Update config but don't reload Traefik
#
# This script:
#   1. Fetches current IPs from Cloudflare official URLs
#   2. Compares with existing config
#   3. Updates traefik.yml if changed
#   4. Restarts Traefik gracefully
#
# Recommended: Run weekly via cron
#   0 3 * * 0 /opt/traefik/bin/update-cloudflare-ips --force >> /var/log/traefik/cf-update.log 2>&1
#
set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TRAEFIK_DIR="$(dirname "$SCRIPT_DIR")"
CONFIG_FILE="${TRAEFIK_DIR}/conf/traefik.yml"
BACKUP_DIR="${TRAEFIK_DIR}/conf/backups"
CF_IPV4_URL="https://www.cloudflare.com/ips-v4/"
CF_IPV6_URL="https://www.cloudflare.com/ips-v6/"

# Options
DRY_RUN=false
FORCE=false
NO_RELOAD=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[INFO]${NC} $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)   DRY_RUN=true; shift ;;
        --force)     FORCE=true; shift ;;
        --no-reload) NO_RELOAD=true; shift ;;
        -h|--help)
            head -20 "$0" | tail -18
            exit 0
            ;;
        *) error "Unknown option: $1"; exit 1 ;;
    esac
done

# Fetch Cloudflare IPs
fetch_cloudflare_ips() {
    info "Fetching Cloudflare IP ranges..."

    local ipv4 ipv6

    ipv4=$(curl -sS --fail --retry 3 --max-time 30 "$CF_IPV4_URL" 2>/dev/null | grep -E '^[0-9]+\.' | sort) || {
        error "Failed to fetch IPv4 ranges"
        return 1
    }

    ipv6=$(curl -sS --fail --retry 3 --max-time 30 "$CF_IPV6_URL" 2>/dev/null | grep -E '^[0-9a-f]+:' | sort) || {
        error "Failed to fetch IPv6 ranges"
        return 1
    }

    # Validate we got reasonable data
    local ipv4_count ipv6_count
    ipv4_count=$(echo "$ipv4" | wc -l)
    ipv6_count=$(echo "$ipv6" | wc -l)

    if [[ $ipv4_count -lt 10 ]] || [[ $ipv6_count -lt 5 ]]; then
        error "Unexpected number of IPs (v4: $ipv4_count, v6: $ipv6_count). Aborting for safety."
        return 1
    fi

    info "Fetched $ipv4_count IPv4 and $ipv6_count IPv6 ranges"

    # Store in temp files for later use
    echo "$ipv4" > /tmp/cf_ipv4.txt
    echo "$ipv6" > /tmp/cf_ipv6.txt
}

# Extract current IPs from config
get_current_ips() {
    grep -E '^\s+- "[0-9a-f:.\/]+"' "$CONFIG_FILE" | \
        sed 's/.*"\([^"]*\)".*/\1/' | \
        grep -v '^127\|^10\.\|^172\.16\|^192\.168' | \
        sort -u
}

# Create backup
create_backup() {
    mkdir -p "$BACKUP_DIR"
    local backup_file="${BACKUP_DIR}/traefik.yml.$(date +%Y%m%d-%H%M%S)"
    cp "$CONFIG_FILE" "$backup_file"
    info "Backup saved: $backup_file"
}

# Generate the IP block for YAML
generate_ip_yaml() {
    local indent="$1"

    echo "${indent}# Cloudflare IPv4 - https://www.cloudflare.com/ips/"
    while IFS= read -r ip; do
        [[ -n "$ip" ]] && echo "${indent}- \"${ip}\""
    done < /tmp/cf_ipv4.txt

    echo "${indent}# Cloudflare IPv6"
    while IFS= read -r ip; do
        [[ -n "$ip" ]] && echo "${indent}- \"${ip}\""
    done < /tmp/cf_ipv6.txt
}

# Update config file using sed
update_config() {
    local temp_file
    temp_file=$(mktemp)

    # Generate replacement block (8 spaces indent for nested YAML)
    local replacement
    replacement=$(generate_ip_yaml "        ")

    # Use awk to replace the Cloudflare IP sections
    # This handles both web and websecure entrypoints
    awk '
    BEGIN { skip = 0 }

    /# Cloudflare IPv4/ {
        skip = 1
        # Print marker for replacement
        print "___CLOUDFLARE_IPS___"
        next
    }

    skip && /^[[:space:]]+- "[0-9a-f:.\/]+"/ { next }
    skip && /# Cloudflare IPv6/ { next }

    # Stop skipping when we hit non-IP content
    skip && !/^[[:space:]]+- "/ && !/^[[:space:]]*#/ && !/^[[:space:]]*$/ {
        skip = 0
    }

    !skip { print }
    ' "$CONFIG_FILE" > "$temp_file"

    # Replace markers with actual IP blocks
    local final_file
    final_file=$(mktemp)

    while IFS= read -r line; do
        if [[ "$line" == "___CLOUDFLARE_IPS___" ]]; then
            generate_ip_yaml "        "
        else
            echo "$line"
        fi
    done < "$temp_file" > "$final_file"

    # Validate result has content
    if [[ ! -s "$final_file" ]]; then
        error "Generated config is empty. Aborting."
        rm -f "$temp_file" "$final_file"
        return 1
    fi

    # Check it still has the key sections
    if ! grep -q "entryPoints:" "$final_file" || ! grep -q "Cloudflare IPv4" "$final_file"; then
        error "Generated config missing required sections. Aborting."
        rm -f "$temp_file" "$final_file"
        return 1
    fi

    # Apply
    mv "$final_file" "$CONFIG_FILE"
    rm -f "$temp_file"

    info "Configuration updated"
}

# Reload Traefik
reload_traefik() {
    info "Restarting Traefik..."

    if ! docker ps --format '{{.Names}}' | grep -q '^traefik$'; then
        warn "Traefik container not running"
        return 0
    fi

    docker restart traefik

    # Wait for healthy
    local retries=10
    while [[ $retries -gt 0 ]]; do
        sleep 2
        local status
        status=$(docker inspect traefik --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")

        if [[ "$status" == "healthy" ]]; then
            info "Traefik restarted and healthy"
            return 0
        fi
        ((retries--))
    done

    warn "Traefik restarted but health status: $status"
}

# Cleanup temp files
cleanup() {
    rm -f /tmp/cf_ipv4.txt /tmp/cf_ipv6.txt 2>/dev/null || true
}
trap cleanup EXIT

# Main
main() {
    echo ""
    info "=== Cloudflare IP Update ==="
    echo ""

    # Check dependencies
    if ! command -v curl &>/dev/null; then
        error "curl is required"
        exit 1
    fi

    # Check config exists
    if [[ ! -f "$CONFIG_FILE" ]]; then
        error "Config file not found: $CONFIG_FILE"
        exit 1
    fi

    # Fetch new IPs
    fetch_cloudflare_ips || exit 1

    # Get current IPs for comparison
    local current_ips new_ips
    current_ips=$(get_current_ips | sort)
    new_ips=$(cat /tmp/cf_ipv4.txt /tmp/cf_ipv6.txt | sort)

    # Compare
    if [[ "$current_ips" == "$new_ips" ]]; then
        info "No changes detected. IPs are up to date."
        exit 0
    fi

    # Show diff
    echo ""
    info "Changes detected:"
    echo ""
    echo "Current IPs: $(echo "$current_ips" | wc -l)"
    echo "New IPs: $(echo "$new_ips" | wc -l)"
    echo ""

    # Show added/removed
    local added removed
    added=$(comm -13 <(echo "$current_ips") <(echo "$new_ips") | head -5)
    removed=$(comm -23 <(echo "$current_ips") <(echo "$new_ips") | head -5)

    [[ -n "$added" ]] && echo -e "${GREEN}Added:${NC}" && echo "$added"
    [[ -n "$removed" ]] && echo -e "${RED}Removed:${NC}" && echo "$removed"
    echo ""

    if $DRY_RUN; then
        info "Dry run - no changes applied"
        exit 0
    fi

    # Confirm
    if ! $FORCE; then
        read -rp "Apply changes? [y/N] " confirm
        if [[ ! "$confirm" =~ ^[Yy] ]]; then
            info "Aborted"
            exit 0
        fi
    fi

    # Create backup
    create_backup

    # Update config
    update_config || {
        error "Update failed. Restore from backup: $BACKUP_DIR"
        exit 1
    }

    # Reload
    if ! $NO_RELOAD; then
        reload_traefik
    else
        warn "Skipping reload (--no-reload). Restart Traefik manually."
    fi

    echo ""
    info "Done!"
}

main "$@"
