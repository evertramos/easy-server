#!/bin/bash
# Generate htpasswd hash for Traefik basic auth using Docker
# Usage: ./bin/gen-password <username> [password]
# If password is not provided, it will be prompted securely

set -e

USERNAME="${1:-}"
PASSWORD="${2:-}"

if [[ -z "$USERNAME" ]]; then
    echo "Usage: $0 <username> [password]"
    echo "Example: $0 admin"
    echo "Example: $0 admin mypassword"
    exit 1
fi

# Prompt for password if not provided
if [[ -z "$PASSWORD" ]]; then
    read -s -p "Password: " PASSWORD
    echo ""
    read -s -p "Confirm password: " PASSWORD_CONFIRM
    echo ""

    if [[ "$PASSWORD" != "$PASSWORD_CONFIRM" ]]; then
        echo "Error: Passwords do not match"
        exit 1
    fi
fi

if [[ -z "$PASSWORD" ]]; then
    echo "Error: Password cannot be empty"
    exit 1
fi

# Generate htpasswd using Docker (httpd image includes htpasswd)
HASH=$(docker run --rm httpd:alpine htpasswd -nbB "$USERNAME" "$PASSWORD")

echo ""
echo "Generated hash:"
echo "$HASH"
echo ""
echo "For .env file (escape \$ with \$\$):"
echo "${HASH//\$/\$\$}"
echo ""
