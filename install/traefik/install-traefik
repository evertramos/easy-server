#!/bin/bash
# Install and configure Traefik on the server
# Usage: ./install-traefik [DESTINATION_FOLDER]
# Example: ./install-traefik /opt

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SOURCE_DIR="$SCRIPT_DIR"

# Destination folder (default: /opt)
DEST_BASE="${1:-/opt}"
DEST_DIR="$DEST_BASE/traefik"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Traefik Installation ===${NC}"
echo "Source: $SOURCE_DIR"
echo "Destination: $DEST_DIR"
echo ""

# Check if source folder exists
if [[ ! -d "$SOURCE_DIR" ]]; then
    echo -e "${RED}Error: Source folder not found: $SOURCE_DIR${NC}"
    exit 1
fi

# Check if base folder exists
if [[ ! -d "$DEST_BASE" ]]; then
    echo -e "${RED}Error: Base folder does not exist: $DEST_BASE${NC}"
    exit 1
fi

# Check if destination folder exists and is not empty
if [[ -d "$DEST_DIR" ]] && [[ -n "$(ls -A "$DEST_DIR" 2>/dev/null)" ]]; then
    echo -e "${RED}Error: Destination folder is not empty: $DEST_DIR${NC}"
    echo -e "${RED}Remove its contents manually if you want to reinstall.${NC}"
    exit 1
fi

# Create destination folder
echo -e "${YELLOW}Creating folder $DEST_DIR...${NC}"
sudo mkdir -p "$DEST_DIR"

# Copy files
echo -e "${YELLOW}Copying files...${NC}"
sudo cp -r "$SOURCE_DIR/conf" "$DEST_DIR/"
sudo cp -r "$SOURCE_DIR/data" "$DEST_DIR/"
sudo cp "$SOURCE_DIR/docker-compose.yml" "$DEST_DIR/"
sudo cp "$SOURCE_DIR/.env.example" "$DEST_DIR/"
sudo cp "$SOURCE_DIR/sample-app.yml" "$DEST_DIR/" 2>/dev/null || true

# Create .env from .env.example
sudo cp "$DEST_DIR/.env.example" "$DEST_DIR/.env"

# Set acme.json permissions (Traefik requirement)
echo -e "${YELLOW}Setting permissions...${NC}"
sudo chmod 600 "$DEST_DIR/data/acme.json"

# Create Docker network if it doesn't exist
echo -e "${YELLOW}Creating Docker network 'proxy'...${NC}"
sudo docker network create proxy 2>/dev/null || echo "Network 'proxy' already exists"

echo ""
echo -e "${GREEN}=== Installation complete ===${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "1. Edit the configuration file:"
echo "   sudo vi $DEST_DIR/.env"
echo ""
echo "2. Configure the required variables:"
echo "   - DASHBOARD_DOMAIN"
echo "   - DASHBOARD_USER (use: htpasswd -nb user password)"
echo "   - WHITELIST_IPS"
echo "   - BUNNY_API_KEY or CF_DNS_API_TOKEN"
echo "   - TUNNEL_TOKEN (if using cloudflared)"
echo ""
echo "3. Start Traefik:"
echo "   cd $DEST_DIR && sudo docker compose up -d"
echo ""
